console.log("Background > Running");var mktoLiveInstances="^https:\/\/app-(sjp|ab07|ab08)+\.marketo\.com",mktoLiveUserPods="app-sjp|app-ab07|app-ab08",mktoLiveDomain="^https:\/\/marketolive.com",mktoLiveMatch="https://marketolive.com/*",mktoLiveUriDomain=".marketolive.com",mktoDomainMatch="https://www.marketo.com/*",mktoUriDomain=".marketo.com",mktoAppDomainMatch="https://app-*.marketo.com",mktoDesignerMatch="https://www.marketodesigner.com/*",mktoDesignerUriDomain=".marketodesigner.com",mktoDesignerMatchPattern="https://*.marketodesigner.com/*",mktoEmailDesignerWebRequestMatch="https://na-sjp.marketodesigner.com/images/templatePicker/richtext-object.svg",mktoEmailDesignerWebRequestRegex="^https:\/\/na-sjp\.marketodesigner\.com\/images\/templatePicker\/richtext-object\.svg$",mktoEmailDesignerFragment="EME",mktoEmailPreviewWebRequestMatch="https://na-sjp.marketodesigner.com/email/emailGetContent?emailId=*",mktoEmailPreviewWebRequestRegex="^https:\/\/na-sjp\.marketodesigner\.com\/email\/emailGetContent\\?emailId=[0-9]+$",mktoEmailPreviewFragmentRegex=new RegExp("#EME[0-9]+&isPreview","i"),mktoEmailPreviewFragment="EMP",mktoLandingPageDesignerFragment="LPE",mktoLandingPagePreviewFragment="LPP",count=0;function getCookie(obj,callback){chrome.cookies.get({"url":obj.url,"name":obj.name},function(cookie){if(cookie){if(cookie.value!=null){console.log("Background > Getting: "+cookie.name+" Cookie for "+cookie.domain+" = "+cookie.value);}
else{console.log("Background > Getting: "+cookie.name+" Cookie for "+cookie.domain+" = null");}
if(callback){callback(cookie);}}
else{console.error("Background > Getting: "+obj.name+" Cookie for "+obj.url+" = undefined");if(callback){callback(null);}}});}
function setCookie(obj){var cookie={url:obj.url,name:obj.name,value:obj.value,domain:obj.domain};chrome.cookies.set(cookie,function(){if(cookie.value!=null){console.log("Background > Setting: "+cookie.name+" Cookie for "+cookie.url+" = "+cookie.value);}
else{console.log("Background > Setting: "+cookie.name+" Cookie for "+cookie.url+" = null");}});}
function removeCookie(obj){var cookie={url:obj.url,name:obj.name};chrome.cookies.remove(cookie,function(){console.log("Background > Removing: "+cookie.name+" Cookie for "+cookie.url);});}
function reloadMarketoTabs(){chrome.tabs.query({url:"*://*.marketo.com/*"},function(tabs){for(var ii=0;ii<tabs.length;ii++){chrome.tabs.reload(tabs[ii].id);}});}
function reloadCompany(tabId){console.log("Background > Reloading: Company Logo & Color");var setAssetData,queryInfo={"currentWindow":true,"url":mktoDesignerMatchPattern},message={"action":"newCompany","assetType":"","assetView":""};function setAssetData(tab){if(tab.url.search("#"+mktoEmailDesignerFragment+"[0-9]+$")!=-1){message.assetType="email";message.assetView="edit";}
else if(tab.url.search("#"+mktoEmailPreviewFragmentRegex)!=-1||tab.url.search("#"+mktoEmailPreviewFragment+"[0-9]+$")!=-1){count=0;message.assetType="email";message.assetView="preview";}
else if(tab.url.search("#"+mktoLandingPageDesignerFragment+"[0-9]+$")!=-1){message.assetType="landingPage";message.assetView="edit";}
else if(tab.url.search("#"+mktoLandingPagePreviewFragment+"[0-9]+$")!=-1){message.assetType="landingPage";message.assetView="preview";}
if(message.assetType&&message.assetView){chrome.tabs.sendMessage(tab.id,message,function(response){console.log("Background > Receiving: Message Response from Content for tab: "+tab.url+" "+response);});message.assetType=message.assetView="";}}
if(tabId){chrome.tabs.get(tabId,function(tab){setAssetData(tab);});}
else{chrome.tabs.query(queryInfo,function(tabs){var ii;for(ii=0;ii<tabs.length;ii++){setAssetData(tabs[ii]);}});}}
chrome.webRequest.onCompleted.addListener(function(details){console.log("Background > webRequest Completed: "+details.url);if(details.url.search(mktoEmailDesignerWebRequestRegex)!=-1){console.log("Background > webRequest Completed: Email Designer");reloadCompany(details.tabId);}
else if(details.url.search(mktoEmailPreviewWebRequestRegex)!=-1){count++;if(count==2){console.log("Background > webRequest Completed: Email Previewer");reloadCompany(details.tabId);}}},{urls:[mktoEmailDesignerWebRequestMatch,mktoEmailPreviewWebRequestMatch]});chrome.runtime.onMessage.addListener(function(message,sender,sendResponse){if(message.action=="setCompanyCookies"){console.log("Background > Receiving: Company Logo & Color");var companyLogoCookieName="logo",companyColorCookieName="color",companyLogoCookieMarketoLive={"url":mktoLiveMatch,"name":companyLogoCookieName,"value":message.logo,"domain":mktoLiveUriDomain},companyLogoCookieDesigner={"url":mktoDesignerMatch,"name":companyLogoCookieName,"value":message.logo,"domain":mktoDesignerUriDomain},companyColorCookieMarketoLive={"url":mktoLiveMatch,"name":companyColorCookieName,"value":message.color,"domain":mktoLiveUriDomain},companyColorCookieDesigner={"url":mktoDesignerMatch,"name":companyColorCookieName,"value":message.color,"domain":mktoDesignerUriDomain};setCookie(companyColorCookieMarketoLive);setCookie(companyColorCookieDesigner);setCookie(companyLogoCookieMarketoLive);setCookie(companyLogoCookieDesigner);reloadCompany();}});function checkForValidUrl(tabId,changeInfo,tab){console.log("Background > Checking: Valid URL");var currentUrl=tab.url,mktoPodCookieMarketo={"url":mktoAppDomainMatch,"name":"mkto_pod"},userPod,userPodCookieName,userPodCookieMarketo,userPodCookieDesigner,userPodCookieMarketoLive;chrome.browserAction.enable(tabId);if(currentUrl.search(mktoLiveInstances)!=-1||currentUrl.search(mktoLiveDomain)!=-1){getCookie(mktoPodCookieMarketo,function(cookie){if(cookie){userPod=cookie.value.split('.')[0].split(':')[1];if(userPod){userPodCookieName="userPod";if(userPod.search(mktoLiveUserPods)!=-1){userPodCookieMarketo={"url":mktoDomainMatch,"name":userPodCookieName,"value":userPod,"domain":mktoUriDomain};userPodCookieDesigner={"url":mktoDesignerMatch,"name":userPodCookieName,"value":userPod,"domain":mktoDesignerUriDomain};userPodCookieMarketoLive={"url":mktoLiveMatch,"name":userPodCookieName,"value":userPod,"domain":mktoLiveUriDomain};setCookie(userPodCookieMarketo);setCookie(userPodCookieDesigner);setCookie(userPodCookieMarketoLive);}}
else{console.error("Background > Checking: "+userPodCookieName+" is null for the tab "+currentUrl);}}
else{console.error("Background > Checking: mkto_pod is null for the tab "+currentUrl);}});}}
chrome.tabs.onUpdated.addListener(checkForValidUrl);