console.log("Background > Running");var mktoLiveInstances="^https:\/\/app-(sjp|ab07|ab08)+\.marketo\.com",mktoLiveUserPods="app-sjp|app-ab07|app-ab08",mktoLiveDomain="^https:\/\/marketolive.com",mktoLiveMatch="https://marketolive.com/*",mktoLiveUriDomain=".marketolive.com",mktoDomainMatch="https://www.marketo.com/*",mktoUriDomain=".marketo.com",mktoAppDomainMatch="https://app-*.marketo.com",mktoDesignerMatch="https://www.marketodesigner.com/*",mktoDesignerUriDomain=".marketodesigner.com";function getCookie(obj,callback){chrome.cookies.get({"url":obj.url,"name":obj.name},function(cookie){if(cookie){if(cookie.value!=null){console.log("Background > Getting: "+cookie.name+" Cookie for "+cookie.domain+" = "+cookie.value);}
else{console.log("Background > Getting: "+cookie.name+" Cookie for "+cookie.domain+" = null");}
if(callback){callback(cookie);}}
else{console.error("Background > Getting: "+obj.name+" Cookie for "+obj.url+" = undefined");if(callback){callback(null);}}});}
function setCookie(obj){var cookie={url:obj.url,name:obj.name,value:obj.value,domain:obj.domain};chrome.cookies.set(cookie,function(){if(cookie.value!=null){console.log("Background > Setting: "+cookie.name+" Cookie for "+cookie.url+" = "+cookie.value);}
else{console.log("Background > Setting: "+cookie.name+" Cookie for "+cookie.url+" = null");}});}
function removeCookie(obj){var cookie={url:obj.url,name:obj.name};chrome.cookies.remove(cookie,function(){console.log("Background > Removing: "+cookie.name+" Cookie for "+cookie.url);});}
function reloadMarketoTabs(){chrome.tabs.query({url:"*://*.marketo.com/*"},function(tabs){for(var ii=0;ii<tabs.length;ii++){chrome.tabs.reload(tabs[ii].id);}});}
chrome.runtime.onMessage.addListener(function(message,sender,sendResponse){if(message.action=="setCompanyCookies"){console.log("Background > Receiving: Company Logo & Color");var companyLogoCookieName="logo",companyColorCookieName="color",companyLogoCookieMarketoLive={"url":mktoLiveMatch,"name":companyLogoCookieName,"value":message.logo,"domain":mktoLiveUriDomain},companyLogoCookieDesigner={"url":mktoDesignerMatch,"name":companyLogoCookieName,"value":message.logo,"domain":mktoDesignerUriDomain},companyColorCookieMarketoLive={"url":mktoLiveMatch,"name":companyColorCookieName,"value":message.color,"domain":mktoLiveUriDomain},companyColorCookieDesigner={"url":mktoDesignerMatch,"name":companyColorCookieName,"value":message.color,"domain":mktoDesignerUriDomain};setCookie(companyColorCookieMarketoLive);setCookie(companyColorCookieDesigner);setCookie(companyLogoCookieMarketoLive);setCookie(companyLogoCookieDesigner);}});function checkForValidUrl(tabId,changeInfo,tab){console.log("Background > Checking: Valid URL");var currentUrl=tab.url,mktoPodCookieMarketo={"url":mktoAppDomainMatch,"name":"mkto_pod"},userPod,userPodCookieName,userPodCookieMarketo,userPodCookieDesigner,userPodCookieMarketoLive;chrome.browserAction.enable(tabId);if(currentUrl.search(mktoLiveInstances)!=-1||currentUrl.search(mktoLiveDomain)!=-1){getCookie(mktoPodCookieMarketo,function(cookie){if(cookie){userPod=cookie.value.split('.')[0].split(':')[1];if(userPod){userPodCookieName="userPod";if(userPod.search(mktoLiveUserPods)!=-1){userPodCookieMarketo={"url":mktoDomainMatch,"name":userPodCookieName,"value":userPod,"domain":mktoUriDomain};userPodCookieDesigner={"url":mktoDesignerMatch,"name":userPodCookieName,"value":userPod,"domain":mktoDesignerUriDomain};userPodCookieMarketoLive={"url":mktoLiveMatch,"name":userPodCookieName,"value":userPod,"domain":mktoLiveUriDomain};setCookie(userPodCookieMarketo);setCookie(userPodCookieDesigner);setCookie(userPodCookieMarketoLive);}}
else{console.error("Background > Checking: "+userPodCookieName+" is null for the tab "+currentUrl);}}
else{console.error("Background > Checking: mkto_pod is null for the tab "+currentUrl);}});}}
chrome.tabs.onUpdated.addListener(checkForValidUrl);